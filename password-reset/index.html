<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Password Reset</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; max-width: 520px; margin: 40px auto; padding: 0 16px; color: #0b1220; }
    h1 { font-size: 22px; margin-bottom: 10px; }
    p { line-height: 1.4; }
    #form { margin-top: 16px; }
    input { padding: 12px; width: 100%; border-radius: 8px; border: 1px solid #d1d5db; }
    button { padding: 12px 16px; border: 0; border-radius: 8px; background: #3b82f6; color: #fff; font-weight: 600; margin-top: 12px; cursor: pointer; }
    .muted { color: #6b7280; font-size: 14px; }
  </style>
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    const supabase = createClient(
      'https://qodanjudswhcgmsuhpbs.supabase.co',
      'sb_publishable_0QU85I7LqcdOaPSVvZVMEg_reQ9GPKe'
    )

    const statusEl = document.getElementById('status')
    const formEl = document.getElementById('form')
    const pwdEl = document.getElementById('pwd')
    const btnEl = document.getElementById('btn')

    async function verifySessionFromUrl() {
      const params = new URLSearchParams(window.location.search)
      const code = params.get('code')

      try {
        if (code) {
          // PKCE / code query param flow
          await supabase.auth.exchangeCodeForSession(code)
        } else if (window.location.hash && window.location.hash.includes('access_token')) {
          // Hash/token flow
          const { error } = await supabase.auth.getSessionFromUrl({ storeSession: true })
          if (error) throw error
        } else {
          throw new Error('Missing code or access token in URL')
        }

        statusEl.textContent = 'Link verified. Enter your new password:'
        formEl.style.display = 'block'

        btnEl.onclick = async (e) => {
          e.preventDefault()
          const pwd = pwdEl.value.trim()
          if (pwd.length < 6) {
            alert('Password must be at least 6 characters.')
            return
          }
          const { error } = await supabase.auth.updateUser({ password: pwd })
          if (error) {
            alert(error.message || 'Failed to update password.')
            return
          }
          statusEl.textContent = 'Password updated! You can now open the app and sign in.'
          formEl.style.display = 'none'
        }
      } catch (e) {
        console.error(e)
        statusEl.textContent = 'Invalid or expired link. Please request a new password reset email.'
      }
    }

    window.addEventListener('DOMContentLoaded', verifySessionFromUrl)
  </script>
</head>
<body>
  <h1>Password Reset</h1>
  <p id="status">Verifying link…</p>
  <form id="form" style="display:none">
    <input id="pwd" type="password" placeholder="New password" autocomplete="new-password" />
    <button id="btn" type="submit">Set Password</button>
  </form>
  <p class="muted">If this page doesn’t work, request a new reset link from the app.</p>
</body>
</html>
