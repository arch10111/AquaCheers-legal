<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Password Reset</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0; background: #f5f7fb; color: #0f172a; }
    .wrap { max-width: 520px; margin: 56px auto; background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 24px; }
    h1 { margin: 0 0 8px; font-size: 22px; }
    p { margin: 8px 0; color: #475569; }
    .error { color: #b91c1c; background: #fee2e2; border: 1px solid #fecaca; padding: 10px 12px; border-radius: 8px; margin: 12px 0; }
    .success { color: #065f46; background: #d1fae5; border: 1px solid #a7f3d0; padding: 10px 12px; border-radius: 8px; margin: 12px 0; }
    .field { margin: 12px 0; }
    label { display: block; font-weight: 700; margin-bottom: 6px; }
    input { width: 100%; font-size: 16px; padding: 10px 12px; border: 1px solid #cbd5e1; border-radius: 8px; }
    button { margin-top: 12px; width: 100%; border: 0; background: #2563eb; color: #fff; font-weight: 800; padding: 12px; border-radius: 10px; cursor: pointer; }
    button[disabled] { opacity: .6; cursor: not-allowed; }
    small { color: #64748b; display: block; margin-top: 6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Password Reset</h1>
    <p id="status">Preparing resetâ€¦</p>

    <div id="form" style="display:none">
      <div class="field">
        <label for="password">New password</label>
        <input id="password" type="password" autocomplete="new-password" />
        <small>Password must be at least 7 characters and include a digit or a special character.</small>
      </div>
      <div class="field">
        <label for="confirm">Confirm password</label>
        <input id="confirm" type="password" autocomplete="new-password" />
      </div>
      <button id="submit">Update password</button>
      <div id="msg"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = 'https://qodanjudswhcgmsuhpbs.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_0QU85I7LqcdOaPSVvZVMEg_reQ9GPKe';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function qs() {
      return new URLSearchParams(window.location.search);
    }
    function hs() {
      const h = window.location.hash.startsWith('#') ? window.location.hash.slice(1) : '';
      return new URLSearchParams(h);
    }
    function validatePassword(pw) {
      if (!pw || pw.length < 7) return false;
      const hasDigit = /\d/.test(pw);
      const hasSpecial = /[!@#$%^&*()_\-+={}[\]|\\:;"'<>,.?/~`]/.test(pw);
      return hasDigit || hasSpecial;
    }
    function clearUrl() {
      history.replaceState(null, '', window.location.pathname);
    }

    async function init() {
      const status = document.getElementById('status');
      const form = document.getElementById('form');
      const msg = document.getElementById('msg');

      // 1) New GoTrue flow: ?code=...
      const code = qs().get('code');
      if (code) {
        const { data, error } = await supabase.auth.exchangeCodeForSession({ code });
        if (error) {
          status.textContent = 'Invalid or expired link. Please request a new password reset email.';
          return;
        }
        clearUrl();
        status.textContent = 'Enter your new password below.';
        form.style.display = '';
        wireSubmit();
        return;
      }

      // 2) Legacy recovery flow: ?token_hash=... (or ?token=...) & type=recovery
      const type = qs().get('type');
      const tokenHash = qs().get('token_hash') || qs().get('token');
      if (type === 'recovery' && tokenHash) {
        const { data, error } = await supabase.auth.verifyOtp({ type: 'recovery', token_hash: tokenHash });
        if (error) {
          status.textContent = 'Invalid or expired link. Please request a new password reset email.';
          return;
        }
        clearUrl();
        status.textContent = 'Enter your new password below.';
        form.style.display = '';
        wireSubmit();
        return;
      }

      // 3) Hash tokens flow: #access_token=...&refresh_token=...
      const access_token = hs().get('access_token');
      const refresh_token = hs().get('refresh_token');
      if (access_token && refresh_token) {
        const { error } = await supabase.auth.setSession({ access_token, refresh_token });
        if (error) {
          status.textContent = 'Invalid or expired link. Please request a new password reset email.';
          return;
        }
        clearUrl();
        status.textContent = 'Enter your new password below.';
        form.style.display = '';
        wireSubmit();
        return;
      }

      // If none matched
      status.textContent = 'Invalid or expired link. Please request a new password reset email.';
    }

    function wireSubmit() {
      const submit = document.getElementById('submit');
      const msg = document.getElementById('msg');
      const status = document.getElementById('status');

      submit.onclick = async () => {
        msg.className = '';
        msg.textContent = '';
        const pw = document.getElementById('password').value;
        const cf = document.getElementById('confirm').value;

        if (pw !== cf) {
          msg.className = 'error';
          msg.textContent = 'Passwords do not match.';
          return;
        }
        if (!validatePassword(pw)) {
          msg.className = 'error';
          msg.textContent = 'Password must be at least 7 characters and include a digit or a special character.';
          return;
        }
        submit.disabled = true;
        const { error } = await supabase.auth.updateUser({ password: pw });
        submit.disabled = false;

        if (error) {
          msg.className = 'error';
          msg.textContent = error.message || 'Failed to update password.';
          return;
        }
        msg.className = 'success';
        msg.textContent = 'Password updated successfully. You can close this tab and sign in with your new password.';
        status.textContent = 'Password updated';
      };
    }

    init();
  </script>
</body>
</html>
